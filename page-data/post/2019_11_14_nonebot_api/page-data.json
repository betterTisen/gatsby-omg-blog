{"componentChunkName":"component---src-templates-post-js","path":"/post/2019_11_14_nonebot_api/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby OMG Blog","post":{"pageviews":true}}},"markdownRemark":{"id":"49c45664-71db-5d14-be5b-d383f921a0c8","excerpt":"ä»€ä¹ˆæ˜¯ NoneBot NoneBot çš„ github åœ°å€ ğŸ‘ˆ NoneBot æ˜¯ä¸€ä¸ªåŸºäº CoolQ HTTP API çš„ python å¼‚æ­¥æœºå™¨äººæ¡†æ¶ã€‚ ç¤ºæ„å›¾ é…· Q docker+CoolQ HTTP API å®‰è£…æ•™ç¨‹ windows åœ¨å®˜ç½‘ ğŸ‘ˆä¸‹è½½å®‰è£…åŒ…å³å¯å®Œæˆå®‰è£…\nmac OS/linuxâ€¦","html":"<h2 id=\"ä»€ä¹ˆæ˜¯-nonebot\">ä»€ä¹ˆæ˜¯ NoneBot</h2>\n<p>NoneBot çš„ <a href=\"https://github.com/richardchien/nonebot\">github åœ°å€ ğŸ‘ˆ</a></p>\n<p>NoneBot æ˜¯ä¸€ä¸ªåŸºäº CoolQ HTTP API çš„ python å¼‚æ­¥æœºå™¨äººæ¡†æ¶ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/richardchien/nonebot/master/diagram.png\" alt=\"ç¤ºæ„å›¾\"></p>\n<div class=\"note success no-icon\">\n  <h3 style=\"margin-top:0\">å®˜æ–¹è§£é‡Šï¼š</h3>\n  <p>æä¾›æå…¶ç®€æ´æ˜“æ‡‚çš„ APIï¼Œä½¿ä½ å¯ä»¥æ¯«æ— å‹åŠ›åœ°å¼€å§‹éªŒè¯ä½ çš„ç»ä½³åˆ›æ„ï¼Œåªéœ€ç¼–å†™æœ€å°‘é‡çš„ä»£ç ï¼Œå³å¯å®ç°ä¸°å¯Œçš„åŠŸèƒ½ã€‚</p>\n  <p>ç²¾å¿ƒè®¾è®¡çš„æ¶ˆæ¯å¤„ç†æµç¨‹åŠå¼ºå¤§çš„ API ä½¿å¾—ä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†æœ€ç®€å•çš„åŸå‹å˜ä¸ºå…·æœ‰å¤§é‡å®ç”¨åŠŸèƒ½çš„å®Œæ•´èŠå¤©æœºå™¨äººï¼Œå¹¶æŒç»­ä¿è¯æ‰©å±•æ€§ã€‚</p>\n  <p>åŸºäºæ—¶ä¸‹æµè¡Œçš„ asyncio æ¨¡å—ï¼Œåˆ©ç”¨ WebSocket è¿›è¡Œé€šä¿¡ï¼Œä»¥è·å¾—æé«˜çš„æ€§èƒ½ï¼›åŒæ—¶ï¼Œæ”¯æŒä½¿ç”¨å¤šä¸ªæœºå™¨äººè´¦å·æ¥è´Ÿè½½å‡è¡¡ç”¨æˆ·æ¶ˆæ¯ï¼Œå‡å°‘ä¸šåŠ¡å®•æœºçš„å¯èƒ½ã€‚</p>\n</div>\n<p><strong>é…· Q docker+CoolQ HTTP API å®‰è£…æ•™ç¨‹</strong></p>\n<p>windows åœ¨<a href=\"https://cqp.cc/t/23253\">å®˜ç½‘ ğŸ‘ˆ</a>ä¸‹è½½å®‰è£…åŒ…å³å¯å®Œæˆå®‰è£…\n<a href=\"https://www.ihewro.com/archives/979/\">mac OS/linuxğŸ‘ˆ</a>çš„å®‰è£…æ•™ç¨‹ç‚¹è¿™é‡Œ</p>\n<p><strong>æ–‡æ¡£</strong></p>\n<p><a href=\"https://cqhttp.cc/\">CoolQ HTTP API 4.12 çš„æ–‡æ¡£ ğŸ‘ˆ</a></p>\n<p><a href=\"https://nonebot.cqp.moe/\">NoneBot æ–‡æ¡£ ğŸ‘ˆ</a></p>\n<h2 id=\"nonebot-çš„éƒ¨ç½²\">NoneBot çš„éƒ¨ç½²</h2>\n<p><strong>1. å®‰è£… docker é•œåƒ</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">#1. å®‰è£…docker</span>\nyum <span class=\"token function\">install</span> docker\n\n<span class=\"token comment\">#2. å®‰è£…é…·Q+httpæ’ä»¶é›†æˆé•œåƒ</span>\ndocker pull richardchien/cqhttp:latest\n\n<span class=\"token comment\">#3. åœ¨dockerä¸­å¯åŠ¨coolq</span>\n<span class=\"token comment\">#  ~/coolq ä¸ºä½ çš„æ–‡ä»¶é•œåƒå®¹å™¨æ‰€åœ¨çš„ä½ç½®</span>\n<span class=\"token comment\"># 4399ä¸ºä½ ç™»é™†VNCåå°çš„ç«¯å£ï¼Œåœ°å€å³ä¸º &lt;äº‘ä¸»æœºip>ï¼š4399</span>\n<span class=\"token comment\"># 12345678ä¸ºä½ çš„VNCåå°ç™»é™†å¯†ç </span>\ndocker run --name<span class=\"token operator\">=</span>coolq --rm -p <span class=\"token number\">4399</span>:9000 -v ~/coolq:/home/user/coolq -e <span class=\"token assign-left variable\">VNC_PASSWD</span><span class=\"token operator\">=</span><span class=\"token number\">12345678</span> -e <span class=\"token assign-left variable\">COOLQ_ACCOUNT</span><span class=\"token operator\">=</span><span class=\"token number\">123456</span> coolq/wine-coolq\n\n<span class=\"token comment\"># ä¸Šé¢çš„æ–¹å¼ä¸ºå‰å°å¯åŠ¨ï¼Œå¦‚éœ€åå°å¯åŠ¨ï¼Œåªéœ€è¦å°†--rmæ¢æˆ-då³å¯ã€‚</span>\n<span class=\"token comment\"># ç„¶åè¾“å…¥</span>\ndocker start coolq\n<span class=\"token comment\"># é€€å‡ºåå°æœåŠ¡</span>\ndocker stop coolq</code></pre></div>\n<p><strong>2. ä¸‹è½½åŠé…ç½® CoolQ Http API åŒ…</strong></p>\n<ul>\n<li>ç‚¹å‡»<a href=\"https://github.com/richardchien/coolq-http-api/releases\">è¿™é‡Œ ğŸ‘ˆ</a>ä¸‹è½½ cpk æ–‡ä»¶</li>\n<li>ç„¶åå°†å…¶æ”¾å…¥ ~/coolq/app ä¸­</li>\n<li>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ &#x3C;äº‘ä¸»æœº ip>ï¼š4399 å¯åŠ¨åå¼€å¯ coolq http api æ’ä»¶</li>\n<li>æ‰¾åˆ° ~/coolq/data/app/io.github.richardchien.coolqhttpapi/config/ ä¸­çš„ json æ–‡ä»¶ï¼Œä¿®æ”¹é‡Œé¢çš„ä¸‰é¡¹é…ç½®</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">// ç«¯å£å¯ä»¥æ”¹ï¼Œä½†æ˜¯ åŠ¡å¿…å’Œåé¢nonebotå¯åŠ¨çš„ç«¯å£ä¿æŒä¸€è‡´</span>\n<span class=\"token comment\">// è¿™ä¸ªæ“ä½œå°±æ˜¯è®©ã€ŒCoolQ HTTP API æ’ä»¶ã€æŠŠæ¥æ”¶ä¿¡æ¯å’Œå‘é€çš„ä¿¡æ¯å€Ÿç»™noneboot æ¨¡å—æ¥æ¥ç®¡ã€‚</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"ws_reverse_api_url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ws://&lt;äº‘ä¸»æœºip>:9999/ws/api/\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ws_reverse_event_url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ws://&lt;äº‘ä¸»æœºip>:9999/ws/event/\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"use_ws_reverse\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>3. ä¸‹è½½ NoneBot</strong></p>\n<ul>\n<li>å»ºè®®å…ˆåœ¨æœ¬æœºç†Ÿæ‚‰ nonebot ç›¸å…³çŸ¥è¯†å¹¶æˆåŠŸå¯åŠ¨æœåŠ¡ã€‚ç‚¹å‡»<a href=\"https://nonebot.cqp.moe/guide/\">è¿™é‡Œ ğŸ‘ˆ</a>æŸ¥çœ‹æ–‡æ¡£</li>\n<li>è¿™æ˜¯æˆ‘çš„ requirements.txt æ–‡ä»¶ï¼Œç¯å¢ƒä¸º python3.7ã€‚å„ä½å¯è‡ªè¡Œæ‹·è´ã€‚ç„¶åé€šè¿‡ pip install -r requirements.txt è¿›è¡Œå®‰è£…</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">aiocache==0.11.1\naiocqhttp==0.6.8\naiofiles==0.4.0\naiohttp==3.6.2\nAPScheduler==3.6.3\nasync-timeout==3.0.1\nattrs==19.3.0\nblinker==1.4\ncertifi==2019.9.11\nchardet==3.0.4\nClick==7.0\nh11==0.9.0\nh2==3.1.1\nhpack==3.0.0\nHypercorn==0.5.4\nhyperframe==5.2.0\nidna==2.8\nitsdangerous==1.1.0\nJinja2==2.10.3\nMarkupSafe==1.1.1\nmsgpack==0.6.2\nmultidict==4.5.2\nnonebot==1.3.1\npytoml==0.1.21\npytz==2019.3\nQuart==0.6.15\nsix==1.13.0\nsortedcontainers==2.1.0\ntyping-extensions==3.7.4.1\ntzlocal==2.0.0\nujson==1.35\nwsproto==0.15.0\nyarl==1.3.0</code></pre></div>\n<p><strong>4. ç¼–å†™ py æ–‡ä»¶</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># bot.pyæ–‡ä»¶</span>\n<span class=\"token keyword\">import</span> nonebot\n<span class=\"token keyword\">from</span> os <span class=\"token keyword\">import</span> path\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    nonebot<span class=\"token punctuation\">.</span>init<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    nonebot<span class=\"token punctuation\">.</span>load_plugins<span class=\"token punctuation\">(</span>\n        path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span>dirname<span class=\"token punctuation\">(</span>__file__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">'plugins'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'plugins'</span>\n    <span class=\"token punctuation\">)</span>\n    nonebot<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>host<span class=\"token operator\">=</span><span class=\"token string\">'0.0.0.0'</span><span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token number\">9999</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>5. æœåŠ¡éƒ¨ç½²</strong></p>\n<p><strong>å‰å°éƒ¨ç½²</strong>ï¼šé€šè¿‡å‘½ä»¤ <code class=\"language-text\">python bot.py</code> å³å¯æˆåŠŸå¯åŠ¨å‰å°æœåŠ¡ï¼ˆæ–­å¼€ ssh ååˆ™ä¼šå¤±æ•ˆï¼‰</p>\n<p><strong>åå°éƒ¨ç½²</strong>ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># ä½¿ç”¨nohupå‘½ä»¤ä»Šå¯è¿›è¡Œåå°éƒ¨ç½²ï¼Œæ–­å¼€sshåä»ç„¶æœ‰æ•ˆ</span>\n<span class=\"token comment\"># æ­¤æ—¶åœ¨bot.pyçš„åŒçº§æ–‡ä»¶ä¸‹ï¼Œä¼šç”Ÿæˆç”Ÿæˆä¸€ä¸ªnohup.outæ–‡ä»¶è®°å½•æ—¥å¿—</span>\n<span class=\"token function\">nohup</span> python bot.py <span class=\"token operator\">&amp;</span>\n<span class=\"token comment\"># æŸ¥çœ‹å¯åŠ¨çš„æœåŠ¡ï¼Œå¹¶æ‰¾åˆ°å¯¹åº”çš„pid</span>\n<span class=\"token function\">ps</span> -ax <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> python\n<span class=\"token comment\"># åœæ­¢æœåŠ¡</span>\n<span class=\"token function\">kill</span> -9 <span class=\"token operator\">&lt;</span>è¿›ç¨‹å·PID<span class=\"token operator\">></span></code></pre></div>\n<h2 id=\"nonebot-å¸¸ç”¨-api\">NoneBot å¸¸ç”¨ Api</h2>\n<p>å› ä¸ºæœ€è¿‘çš„ bot å¼€å‘é€‰ç”¨äº†æ­¤æ¡†æ¶ã€‚æ•…åœ¨æ­¤è¿›è¡Œäº†å®ç”¨ api çš„è®°å½•å’Œæ•´ç†ï¼Œä¸ºä»¥åè¿›è¡Œå¼€å‘åšä¸€ä¸ªè®°å½•ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿å…¶ä»–åˆšæ¥è§¦æ­¤æ¡†æ¶çš„å°ä¼™ä¼´å¿«é€Ÿä¸Šæ‰‹ã€‚</p>\n<p><strong>on_command (å‘½ä»¤é…ç½®):</strong></p>\n<p>å°†å‡½æ•°è£…é¥°ä¸ºå‘½ä»¤å‡½æ•°</p>\n<p><strong>args_parser:</strong></p>\n<p>å°†å‡½æ•°è£…é¥°ä¸ºå‘½ä»¤å±‚é¢çš„å‚æ•°è§£æå™¨ï¼Œå°†åœ¨å‘½ä»¤å®é™…å¤„ç†å‡½æ•°ä¹‹å‰è¢«è¿è¡Œã€‚æ¥å—çš„å‚æ•°ä¸º<code class=\"language-text\">CommandSession</code></p>\n<p><strong>CommandSession å¸¸ç”¨å‚æ•°:</strong></p>\n<ul>\n<li>\n<p><code class=\"language-text\">state</code>: å±æ€§æœ¬èº«åªè¯»ï¼Œä½†å±æ€§ä¸­çš„å†…å®¹å¯è¯»å†™ã€‚</p>\n<ul>\n<li><strong>è¯»</strong>: session.state.get(â€˜xxxâ€™)</li>\n<li><strong>å†™</strong>: session.state[â€˜xxxâ€™]=â€˜xxxxâ€™</li>\n</ul>\n</li>\n<li><code class=\"language-text\">is_first_run</code>: æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ</li>\n<li><code class=\"language-text\">current_arg_text</code>: å±æ€§çš„çº¯æ–‡æœ¬éƒ¨åˆ†ï¼ˆä¸åŒ…å« CQ ç ï¼‰ï¼Œå„éƒ¨åˆ†ä½¿ç”¨ç©ºæ ¼è¿æ¥ã€‚</li>\n</ul>\n<p><strong>å‘½ä»¤æƒé™</strong></p>\n<ul>\n<li>PRIVATE_FRIEND(0x0001): å¥½å‹ç§èŠ</li>\n<li>PRIVATE_GROUP(0x0002): ç¾¤ä¸´æ—¶ç§èŠ</li>\n<li>PRIVATE_DISCUSS(0x0004): è®¨è®ºç»„ä¸´æ—¶ç§èŠ</li>\n<li>PRIVATE_OTHER(0x0008): å…¶å®ƒç§èŠ</li>\n<li>PRIVATE(0x000F): ä»»ä½•ç§èŠ</li>\n<li>DISCUSS(0x00F0): è®¨è®ºç»„</li>\n<li>GROUP_MEMBER(0x0100): ç¾¤æˆå‘˜</li>\n<li>GROUP_ADMIN(0x0200): ç¾¤ç®¡ç†å‘˜</li>\n<li>GROUP_OWNER(0x0400): ç¾¤ä¸»</li>\n<li>GROUP(0x0F00): ä»»ä½•ç¾¤æˆå‘˜</li>\n<li>SUPERUSER(0xF000): è¶…çº§ç”¨æˆ·</li>\n<li>EVERYBODY(0xFFFF): ä»»ä½•äºº</li>\n<li>IS_NOBODY(0x0000): ç¦æ­¢ä»»ä½•äºº</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">  <span class=\"token keyword\">from</span> nonebot <span class=\"token keyword\">import</span> permission\n  @nonebot<span class=\"token punctuation\">.</span>on_command<span class=\"token punctuation\">(</span><span class=\"token string\">'hello'</span><span class=\"token punctuation\">,</span> permission<span class=\"token operator\">=</span>permission<span class=\"token punctuation\">.</span>PRIVATE <span class=\"token operator\">|</span> permission<span class=\"token punctuation\">.</span>GROUP_ADMIN<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">_</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span></code></pre></div>\n<p><strong>on_messageï¼ˆæ”¶åˆ°æ¶ˆæ¯ï¼‰:</strong></p>\n<p>å°†å‡½æ•°è£…é¥°ä¸ºæ¶ˆæ¯äº‹ä»¶çš„å¤„ç†å‡½æ•°</p>\n<ul>\n<li><code class=\"language-text\">private</code>: ç§èŠæ¶ˆæ¯</li>\n<li><code class=\"language-text\">group</code>: ç¾¤æ¶ˆæ¯</li>\n</ul>\n<p><strong>on_noticeï¼ˆç¾¤ã€è®¨è®ºç»„å˜åŠ¨ç­‰é€šçŸ¥ç±»äº‹ä»¶ï¼‰:</strong></p>\n<p>å°†å‡½æ•°è£…é¥°ä¸ºé€šçŸ¥äº‹ä»¶çš„å¤„ç†å‡½æ•°</p>\n<ul>\n<li><code class=\"language-text\">group_upload</code>ï¼šç¾¤æ–‡ä»¶ä¸Šä¼ </li>\n<li><code class=\"language-text\">group_decrease</code>ï¼šç¾¤æˆå‘˜å‡å°‘</li>\n<li><code class=\"language-text\">group_increase</code>ï¼šç¾¤æˆå‘˜å¢åŠ </li>\n<li><code class=\"language-text\">friend_add</code>ï¼šå¥½å‹æ·»åŠ ï¼ˆå®˜æ–¹æ–‡æ¡£è¯´æ˜¯å¥½å‹æ·»åŠ çš„ç›¸åº”äº‹ä»¶ï¼Œå¯æ˜¯æœ¬äººæµ‹è¯•å‘ç°æ— æ•ˆï¼‰</li>\n</ul>\n<p><strong>on_requestï¼ˆåŠ å¥½å‹è¯·æ±‚ã€åŠ ç¾¤è¯·æ±‚ï¼é‚€è¯·ï¼‰:</strong></p>\n<p>å°†å‡½æ•°è£…é¥°ä¸ºè¯·æ±‚äº‹ä»¶çš„å¤„ç†å‡½æ•°</p>\n<ul>\n<li><code class=\"language-text\">friend</code>:æœ‰äººå‘é€æ·»åŠ å¥½å‹è¯·æ±‚æ—¶è§¦å‘</li>\n<li><code class=\"language-text\">group</code>:æœ‰äººå‘é€åŠ å…¥ç¾¤è¯·æ±‚æ—¶è§¦å‘</li>\n</ul>\n<p><strong>CQ ç ï¼ˆè¡¨æƒ…ï¼‰</strong></p>\n<p>qq è‡ªå¸¦è¡¨æƒ… [CQ:face,id=è¡¨æƒ… id]ï¼š\n<a href=\"https://cqp.cc/t/36910\">å¯¹ç…§è¡¨ ğŸ‘ˆ</a></p>\n<p>emoji è¡¨æƒ… [CQ:emoji,id=è¡¨æƒ… id]ï¼š\n<a href=\"https://cqp.cc/t/15827\">å¯¹ç…§è¡¨ ğŸ‘ˆ</a></p>","headings":[{"value":"ä»€ä¹ˆæ˜¯ NoneBot","depth":2},{"value":"NoneBot çš„éƒ¨ç½²","depth":2},{"value":"NoneBot å¸¸ç”¨ Api","depth":2}],"frontmatter":{"title":"NoneBot å¼€å‘è®°å½•","date":"November 14, 2019","description":null,"tags":["python","coolq","nonebot"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/2019_11_14_nonebot_api/","previous":{"fields":{"slug":"/post/2019_10_26_markdown_study/"},"frontmatter":{"title":"markdownåœ¨omgä¸­çš„æ¸²æŸ“æ•ˆæœå±•ç¤º"}},"next":{"fields":{"slug":"/post/2019_12_16_css_grid/"},"frontmatter":{"title":"æµ…è°ˆ CSS Grid å¸ƒå±€"}}}}}