---
title: æ–°ç“¶æ—§é…’ï¼šå¦‚ä½•ç”¨jså†™ä¸€ä¸ªjsè§£é‡Šå™¨
date: 2020-4-21 18:00:00
description: ç¼–è¯‘åŸç†æ˜¯è®¡ç®—æœºå­¦ç§‘ä¸­ä¸€ä¸ªå¾ˆä¼Ÿå¤§å¾ˆé‡è¦çš„æ¦‚å¿µï¼šå³è®¡ç®—æœºè¯†åˆ«è‡ªç„¶è¯­è¨€çš„ä¸€ä¸ªè§£æè¿‡ç¨‹ã€‚å•ç‹¬æ‹å‡ºæ¥è¯´çš„è¯ä¹Ÿå¾ˆéš¾æ¦‚æ‹¬å…¶å®Œæ•´çš„çŸ¥è¯†ç‚¹ï¼Œè€Œä¸”ç¬”è€…ä¹Ÿåªæ˜¯çŸ¥å…¶çš®æ¯›è€Œå·²ï¼ˆè¿˜éœ€åŠªåŠ› ğŸ’ªï¼‰ã€‚ã€‚ã€‚ä½†æ˜¯é€šä¿—ä¸€ç‚¹æ¦‚æ‹¬çš„è¯ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆç”µè„‘å¯ä»¥å°†ä¸€ä¸² js å­—ç¬¦ä¸²æ­£ç¡®çš„è®©æœºå™¨è¯†åˆ«ã€‚ä»è€Œå¾—åˆ°ä½ æƒ³è¦çš„æ•ˆæœã€‚ä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„å¤§ä½“è§£ææ­¥éª¤æ˜¯æ€æ ·çš„ã€‚
tags:
  - javascript
---

> æƒ³çœ‹ä»£ç çš„ç›´æ¥ä¸‹è½½é¡¹ç›®å³å¯ï¼Œé‡Œé¢æ³¨é‡Šå†™çš„è¿˜ç®—è¯¦ç»†ã€‚
> é¡¹ç›®åœ°å€ï¼š[https://github.com/betterTisen/oreojs](https://github.com/betterTisen/oreojs)

## ç¼–è¯‘åŸç†åŸºç¡€

ç¼–è¯‘åŸç†æ˜¯è®¡ç®—æœºå­¦ç§‘ä¸­ä¸€ä¸ªå¾ˆä¼Ÿå¤§å¾ˆé‡è¦çš„æ¦‚å¿µï¼šå³è®¡ç®—æœºè¯†åˆ«è‡ªç„¶è¯­è¨€çš„ä¸€ä¸ªè§£æè¿‡ç¨‹ã€‚å•ç‹¬æ‹å‡ºæ¥è¯´çš„è¯ä¹Ÿå¾ˆéš¾æ¦‚æ‹¬å…¶å®Œæ•´çš„çŸ¥è¯†ç‚¹ï¼Œè€Œä¸”ç¬”è€…ä¹Ÿåªæ˜¯çŸ¥å…¶çš®æ¯›è€Œå·²ï¼ˆè¿˜éœ€åŠªåŠ› ğŸ’ªï¼‰ã€‚ã€‚ã€‚ä½†æ˜¯é€šä¿—ä¸€ç‚¹æ¦‚æ‹¬çš„è¯ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆ**ç”µè„‘å¯ä»¥å°†ä¸€ä¸² js å­—ç¬¦ä¸²æ­£ç¡®çš„è®©æœºå™¨è¯†åˆ«ã€‚ä»è€Œå¾—åˆ°ä½ æƒ³è¦çš„æ•ˆæœ**ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„å¤§ä½“è§£ææ­¥éª¤æ˜¯æ€æ ·çš„ã€‚

### è§£ææ­¥éª¤

1. js å­—ç¬¦ä¸²é€šè¿‡è¯æ³•åˆ†æå’Œå¥æ³•åˆ†æè§£ææˆä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘ï¼ˆé€šè¿‡ç¬¬ä¸‰æ–¹åº“ acorn å®ç°ï¼‰
2. æ ¹æ®æŠ½è±¡è¯­æ³•æ ‘å¯¹ä¸åŒ type è¿›è¡Œç›¸åº”çš„è§£æï¼ˆè¿™é‡Œæ˜¯æœ¬ç¯‡æ–‡ç« éœ€è¦å®Œæˆçš„ï¼‰

### JavaScript è¯­æ³•æ ‘ type çš„åŸºæœ¬è®¤çŸ¥

æˆ‘æ¨èè¿™ä¸€ç¯‡æ–‡ç« ï¼Œå¤§å®¶å¯ä»¥å¿«é€Ÿé¢„è§ˆä¸€ä¸‹ï¼Œå¯¹ js ast çš„å¸¸è§ type æ··ä¸ªçœ¼ç†Ÿï¼Œä¸ç„¶ä¸€å¼€å§‹å°±æ’¸ä»£ç å¯èƒ½ä¼šä¸çŸ¥å¦‚ä½•ä¸Šæ‰‹ã€‚ã€‚

## å‡†å¤‡å·¥ä½œ

- ç¬¬ä¸‰æ–¹åº“ï¼šacorn
- ä¸€ä¸ªè¯­æ³•æ ‘ç”Ÿæˆçš„åœ¨çº¿é¢„è§ˆå·¥å…·ï¼š[https://astexplorer.net](https://astexplorer.net)

å»ºè®®å„ä½å¯ä»¥å…ˆåœ¨ä¸Šé¢çš„ç½‘å€ä¸­éšæ„çš„å†™ä¸€æ®µç®€å•çš„ js ä»£ç ï¼Œç„¶åçœ‹ä¸€çœ‹ç”Ÿæˆçš„è¯­æ³•æ ‘ç»“æ„ï¼ˆå…¶å®å°±æ˜¯ä¸€ä¸ª json å¯¹è±¡ï¼‰ã€‚_ä¸»è¦æ³¨æ„æ¯ä¸€é¡¹çš„ typeï¼Œstart å’Œ end å¯ä»¥å¿½ç•¥ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ°_

çœ‹ä¸€ä¸‹å®ç°åçš„æ•ˆæœã€‚ç„¶åå°±å¼€å§‹æ’¸ä»£ç å§

![result](./1.gif)

## èŠ‚ç‚¹éå†å™¨ï¼ˆnodeIteratorï¼‰

é¦–å…ˆï¼Œé€šè¿‡è¯­æ³•æ ‘çš„ç»“æ„å¯çŸ¥ï¼Œæˆ‘ä»¬è¦å¤„ç†çš„è¿™ä¸ª json æ˜¯ä¸€ä¸ªè¾ƒæ·±çš„æ ‘å½¢ç»“æ„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªéå†å™¨ï¼Œæ¥ä¸€å±‚ä¸€å±‚çš„éå†èŠ‚ç‚¹ã€‚çœ‹ä¸‹å®ç°çš„ä»£ç ï¼Œå…¶ä¸­ scope å’Œ NodeHandlerï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢çš„æ®µè½å’Œå¤§å®¶è¯¦ç»†ä»‹ç»ï¼Œç°åœ¨ä½ åªéœ€è¦çŸ¥é“ï¼Œnode æ˜¯è¯­æ³•æ ‘çš„ jsonï¼Œtraverse æ˜¯æ ¹æ® json çš„ type è¿›è¡Œä¸åŒè§£æçš„æ–¹æ³•

```javascript
class NodeIterator {
  constructor(node, scope) {
    //nodeï¼Œå°±æ˜¯æ ‘ï¼Œéšç€èŠ‚ç‚¹çš„éå†ï¼Œä¼šæœ‰ä¸åŒçš„å­æ ‘è¢«ä¼ å…¥
    this.node = node
    //å½“å‰çš„ä½œç”¨åŸŸ
    this.scope = scope
    //å¯¹å„ç±»èŠ‚ç‚¹çš„å¤„ç†
    this.nodeHandler = NodeHandler
  }

  // ç”¨äºä½œç”¨åŸŸå¤„ç†ï¼Œåé¢ä¼šè¯´
  createScope() {
    return new Scope(this.scope)
  }

  traverse(node, opt = {}) {
    //å¦‚æœoptä¼ å…¥typeï¼Œåˆ™ä½¿ç”¨ä¼ å…¥çš„typeï¼Œè¿™é‡Œçš„æ„æ€æ˜¯å¦‚æœå­æ ‘æ˜¯ä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼Œåˆ™ä½¿ç”¨å…¨æ–°çš„ä½œç”¨åŸŸï¼Œå¦åˆ™ï¼Œå…¶ä½œç”¨åŸŸä»æ˜¯å½“å‰ä½œç”¨åŸŸ
    const scope = opt.scope ? opt.scope : this.scope
    const _evel = this.nodeHandler[node.type]
    const nodeIterator = new NodeIterator(node, scope)
    if (!_evel) {
      throw new Error(`Unknown node type "${node.type}"`)
    }
    return _evel(nodeIterator)
  }
}
```

## ä½œç”¨åŸŸå¤„ç†ï¼ˆscopeï¼‰

è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸Šé¢çš„èŠ‚ç‚¹éå†å™¨å¦‚æœæ²¡æœ‰å¤„ç†ä½œç”¨åŸŸä¼šæ€æ ·ï¼Ÿé‚£ä¸æ˜¯æ¯ä¸€ä¸ªå£°æ˜çš„å˜é‡éƒ½ä¼šå¤„äºå…¨å±€ä¹‹ä¸­å—ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç±»æ¥å¯¹ä½œç”¨åŸŸè¿›è¡Œç®¡ç†ã€‚ä¸‹é¢çš„ä»£ç å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä½œç”¨åŸŸå¤„ç†ç±»ï¼Œä¸è¦çœ‹å®ƒè¿™ä¹ˆé•¿ï¼Œå…¶å®å¾ˆç®€å•  
çœ‹ **constructor**ï¼Œè¿™ä¸ªç±»åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæœ‰ä¸‰ä¸ªå±æ€§ï¼Œåˆ†åˆ«æ˜¯è‡ªå·±çš„ä½œç”¨åŸŸï¼Œçˆ¶çº§ä½œç”¨åŸŸï¼Œå…¨å±€ä½œç”¨åŸŸã€‚ä¸‹é¢çš„ get æ–¹æ³•ï¼Œå³æ˜¯è·å–å˜é‡çš„å€¼ï¼Œåœ¨å½“å‰ä½œç”¨åŸŸæ‰¾ï¼Œæ‰¾ä¸åˆ°å°±åˆ°çˆ¶çº§æ‰¾ï¼ˆæ³¨æ„ï¼Œå¾€çˆ¶çº§æŸ¥æ‰¾æ˜¯ä¸€ä¸ªé€’å½’ï¼‰ï¼Œæœ€åæ‰¾åˆ°å…¨å±€ï¼Œset æ–¹æ³•ä¹Ÿä¸€æ ·

```javascript
class Scope {
  constructor(parentScope) {
    this.parentScope = parentScope
    this.globalDeclaration = globalMap
    this.declaration = Object.create(null) // æ¯æ¬¡éƒ½æ–°å»ºä¸€ä¸ªå…¨æ–°çš„ä½œç”¨åŸŸ
  }

  // è·å–å˜é‡å€¼
  get(name) {
    if (this.declaration[name]) {
      return this.declaration[name]
    } else if (this.parentScope) {
      return this.parentScope.get(name)
    } else if (this.globalDeclaration[name]) {
      return this.globalDeclaration[name]
    }
    throw new ReferenceError(`${name} is not defined`)
  }

  // å¯¹å·²å®šä¹‰å˜é‡èµ‹å€¼
  set(name, value) {
    if (this.declaration[name]) {
      this.declaration[name].set(value)
    } else if (this.parentScope) {
      this.parentScope.set(name, value)
    } else if (this.globalDeclaration[name]) {
      return this.globalDeclaration.set(name, value)
    } else {
      throw new ReferenceError(`${name} is not defined`)
    }
  }

  // æŠ½è±¡äº†ä¸‰ç§å˜é‡å®šä¹‰æ–¹å¼
  declare(name, value, kind = "var") {
    if (kind === "var") {
      return this.varDeclare(name, value)
    } else if (kind === "let") {
      return this.letDeclare(name, value)
    } else if (kind === "const") {
      return this.constDeclare(name, value)
    } else {
      throw new Error(`OreoJs: Invalid Variable Declaration Kind of "${kind}"`)
    }
  }

  varDeclare(name, value) {
    // ç”±äºvarç±»å‹æœ‰ç€å˜é‡æå‡çš„ç‰¹æ€§ã€‚åœ¨è¿™é‡Œæˆ‘ç›´æ¥ä½¿ç”¨letçš„æ–¹å¼æ¥è§£ævarï¼Œé¡¾è¿™é‡Œçš„varå¹¶æ²¡æœ‰åšå˜é‡æå‡
    this.letDeclare(name, value)
  }

  letDeclare(name, value) {
    // ä¸å…è®¸é‡å¤å®šä¹‰
    if (this.declaration[name]) {
      throw new SyntaxError(`Identifier ${name} has already been declared`)
    }
    this.declaration[name] = new SimpleValue(name, value, "let")
    return this.declaration[name]
  }

  constDeclare(name, value) {
    // ä¸å…è®¸é‡å¤å®šä¹‰
    if (this.declaration[name]) {
      throw new SyntaxError(`Identifier ${name} has already been declared`)
    }
    this.declaration[name] = new SimpleValue(name, value, "const")
    return this.declaration[name]
  }
}
```

ä¸Šé¢çš„ä»£ç ä¸­æœ‰ä¸€ä¸ª SimpleValueï¼Œå’Œ ä¸€ä¸ª globalMapã€‚

- SimpleValueï¼šå®šä¹‰å˜é‡å€¼ï¼Œä¸»è¦ç”¨äºå¤„ç†å¸¸é‡
- globalMapï¼šæ³¨å…¥å…¨å±€å˜é‡

æ²¡å•¥å¥½è¯´çš„ï¼Œç›´æ¥è´´ä»£ç 

```javascript
// SimpleValue.js
class SimpleValue {
  constructor(name, value, kind = "") {
    this.name = name
    this.value = value
    this.kind = kind
  }

  set(value) {
    // ç¦æ­¢é‡æ–°å¯¹constç±»å‹å˜é‡èµ‹å€¼
    if (this.kind === "const") {
      throw new Error(`"${this.name}" is read-only`)
    } else {
      this.value = value
    }
  }

  get() {
    return this.value
  }
}
// globalMap.js
import SimpleValue from "../util/simpleValue"

const globalMap = {
  window: new SimpleValue("window", window),
  console: new SimpleValue("console", console),
  Date: new SimpleValue("Date", Date),
}
```

## å„ç±»èŠ‚ç‚¹å¤„ç†ï¼ˆnodeHandlerï¼‰

å½“ä½œç”¨åŸŸçš„é—®é¢˜è§£å†³ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªç¹å¤çš„å·¥ä½œäº†ï¼šå¯¹ä¸åŒ type çš„ tree è¿›è¡Œè§£æã€‚è¿™é‡Œçš„ nodeHandler å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„å¯¹å„ç±»èŠ‚ç‚¹çš„å¤„ç†

**æ ¹èŠ‚ç‚¹å¤„ç†å™¨ Program**

æ ¹èŠ‚ç‚¹æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥åªéœ€è¦å¯¹æ•°ç»„è¿›è¡Œå¾ªç¯è§£é‡Šå³å¯

```javascript
Program(nodeIterator) {
  for (const e of nodeIterator.node.body) {
    nodeIterator.traverse(e)
  }
}
```

**å˜é‡å®šä¹‰èŠ‚ç‚¹å¤„ç†å™¨ VariableDeclaration**

è¿™é‡ŒåŸºæœ¬å°±æ˜¯æ ¹æ®å®šä¹‰å˜é‡çš„æ•°é‡ä»¥åŠç±»å‹ï¼Œå¾ªç¯è¿›è¡Œèµ‹å€¼

```javascript
VariableDeclaration(nodeIterator) {
  const { kind } = nodeIterator.node
  const variableNodes = nodeIterator.node.declarations
  for (const variableNode of variableNodes) {
    const k = variableNode.id.name
    const v = variableNode.init ? nodeIterator.traverse(variableNode.init) : undefined
    nodeIterator.scope.declare(k, v, kind)
  }
}
```

**æ ‡è¯†ç¬¦èŠ‚ç‚¹å¤„ç†å™¨ Identifier**

æ³¨æ„ï¼Œè¿™é‡Œçš„æ–¹æ³•åªç”¨äºè¯»å–å€¼

```javascript
// æ ‡è¯†ç¬¦(ç”¨äºè¯»å–å€¼)
Identifier(nodeIterator) {
  const { name } = nodeIterator.node

  if (name === "undefined") {
    return undefined
  }

  return nodeIterator.scope.get(nodeIterator.node.name).value
}
```

**å­—ç¬¦èŠ‚ç‚¹å¤„ç†å™¨ Literal**

å­—é¢é‡ç›´æ¥è¿”å›å°±å¥½

```javascript
//å­—é¢é‡
Literal(nodeIterator) {
    return nodeIterator.node.value
}
```

**è¡¨è¾¾å¼è°ƒç”¨èŠ‚ç‚¹å¤„ç†å™¨ CallExpression**

å‡½æ•°è°ƒç”¨ï¼Œè¿™é‡Œæ³¨æ„æœ€åreturnçš„ç»“æœéœ€è¦è®©thisæŒ‡å‘func

```javascript
// å‡½æ•°è°ƒç”¨è¡¨è¾¾å¼ï¼Œå³è¡¨ç¤ºäº† func(1, 2) è¿™ä¸€ç±»å‹çš„è¯­å¥
CallExpression(nodeIterator) {
  const func = nodeIterator.traverse(nodeIterator.node.callee)
  const args = nodeIterator.node.arguments.map((arg) => nodeIterator.traverse(arg))
  let value
  if (nodeIterator.node.callee.type === "MemberExpression") {
    value = nodeIterator.traverse(nodeIterator.node.callee.object)
  }
  return func.apply(value, args)
}
```

**è¡¨è¾¾å¼èŠ‚ç‚¹å¤„ç†å™¨ MemberExpression**

```javascript
// æˆå‘˜è¡¨è¾¾å¼èŠ‚ç‚¹ï¼Œå³è¡¨ç¤ºå¼•ç”¨å¯¹è±¡æˆå‘˜çš„è¯­å¥
MemberExpression(nodeIterator) {
  const obj = nodeIterator.traverse(nodeIterator.node.object)
  const { name } = nodeIterator.node.property
  return obj[name]
}
```

å…¶ä»–çš„èŠ‚ç‚¹å¤„ç†æ–¹å¼å¯ä»¥é€šè¿‡é¡¶éƒ¨çš„åœ°å€å»çœ‹ï½è¿™é‡ŒçŸ¥è¯†åˆ—å‡ºäº†å¸¸è§çš„èŠ‚ç‚¹å¤„ç†æ–¹å¼ï¼Œåªè¦é€æ­¥å®Œå–„è¿™é‡Œçš„æ–¹æ³•ï¼Œè®©è¿™ä¸ªå¯¹è±¡å¯¹å„ç±»èŠ‚ç‚¹éƒ½æ”¯æŒè§£æï¼Œå°±å®Œæˆäº†ä¸€ä¸ªåŸºæœ¬çš„è§£é‡Šå™¨

## æ€»ç»“

æ€»ç»“ä¸€ä¸‹ï¼Œå†™è¿™ä¸ªè§£é‡Šå™¨æœ€å¤æ‚çš„å°±æ˜¯å¤„ç†ä½œç”¨åŸŸçš„é—®é¢˜ï¼Œç†è§£äº†è¿™ä¸ªè§£æå™¨é€’å½’è§£é‡Šæ ‘çš„æ€è·¯åï¼Œå°±æ˜¯å»å†™NodeIteratorä¸­ä¸åŒtypeæ‰€å¯¹åº”çš„æ–¹æ³•å°±è¡Œå•¦ï¼Œçœ‹å®Œè¿™è¾¹æ–‡ç« åè¿˜ä¸äº†è§£çš„è¯å¯ä»¥æŠŠgithubçš„ä»£ç æ‹‰ä¸‹æ¥ï¼Œé€šè¿‡æ•´ä¸ªé¡¹ç›®å»çœ‹æ›´å®¹æ˜“ç†è§£ä¸€äº›ï¼Œæ¯•ç«Ÿæ–‡ç« ç¯‡å¹…æœ‰é™ã€‚

## å‚è€ƒèµ„æ–™

[å‰ç«¯ä¸ç¼–è¯‘åŸç†â€”â€”ç”¨ JS å†™ä¸€ä¸ª JS è§£é‡Šå™¨](https://segmentfault.com/a/1190000017241258#item-6-2)

[jrainlau/canjs](https://github.com/jrainlau/canjs)
